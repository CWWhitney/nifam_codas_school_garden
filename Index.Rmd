---
title: "Index"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Methods 

### Chance Event Function: Generating Conditional Values

The `chance_event` function generates conditional values with: 

   \[
   occurrence =
   \begin{cases}
   rbinom(length(value\_if), 1, chance) & if  !one\_draw \\
   rbinom(1, 1, chance) & if  one\_draw
   \end{cases}
   \]
   
and final values with: 

   \[
   chance\_event = occurrence \cdot value\_if + (1 - occurrence) \cdot value\_if\_not
   \]

### Value Varier Function: Generating Synthetic Data

```{r vv}
source("functions/vv.R")
```

The `vv` function generates synthetic data with varying means and coefficients of variation with: 

- \( n \): Number of data points to generate.
- \( var\_mean \): Mean value for the data.
- \( var\_CV \): Coefficient of Variation (CV) for the data.
- \( distribution \): Distribution of the data (e.g., normal distribution).
- \( absolute\_trend \): Absolute trend to add to the data.
- \( relative\_trend \): Relative trend to apply to the data.
- \( lower\_limit \): Lower limit for generated data.
- \( upper\_limit \): Upper limit for generated data.

These are used to calculate annual means: 

   - If both absolute and relative trends are absent, the annual means remain constant:

     \[
     annual\_means = var\_mean
     \]

   - If an absolute trend is present, annual means are adjusted linearly:

     \[
     annual\_means = var\_mean + absolute\_trend \cdot (0, 1, \ldots, n-1)
     \]

   - If only a relative trend is present, annual means change multiplicatively:

     \[
     annual\_means = var\_mean \cdot (1 + relative\_trend / 100)^{(0, 1, \ldots, n-1)}
     \]

   - Generate random data points based on the specified distribution using calculated annual means:

     \[
     out \sim \mathcal{N}(annual\_means, \lvert annual\_means \rvert \cdot \frac{var\_CV}{100})
     \]

   - If specified, limit data points to the defined lower and upper limits:

     \[
     out = \max(out, lower\_limit), \quad out = \min(out, upper\_limit)
     \]

### Net Present Value (NPV)

```{r NPV}
source("functions/discount.R")
```

The discounted value of a time series value \(x_t\) at time \(t\) can be calculated using the formula:

   \[
   \text{Discounted Value}_t = \frac{x_t}{\left(1 + \frac{\text{Discount Rate}}{100}\right)^{t-1}}
   \]

   Where:
   
   - \(x_t\) is the value at time \(t\),
   
   - \(\text{Discount Rate}\) is the discount rate provided to the function,
   
   - \(t\) is the time period (starting from 1).

2. **Net Present Value (NPV)** (if `calculate_NPV` is set to `TRUE`):
   The Net Present Value of a time series with discounted values can be calculated as the sum of all discounted values:

   \[
   \text{NPV} = \sum_{t=1}^{n} \frac{x_t}{\left(1 + \frac{\text{Discount Rate}}{100}\right)^{t-1}}
   \]

   Where \(n\) is the number of time periods in the time series.

## Monte Carlo Simulation Function

```{r MC}
source("functions/mcSimulation.R")
```

The `mcSimulation` function performs Monte Carlo simulations to estimate model outputs based on provided parameters and a model function.

## Monte Carlo Simulation Process

The Monte Carlo simulation process generates a set of estimated model outputs based on random input samples, providing a distribution of potential outcomes including:

- random input generation with \( x_1, x_2, \ldots, x_n \) as a set of \( n \) random input samples drawn from a given distribution, representing the input parameters of the model.

- a model function \( f(x) \) that maps the input data \( x \) to the corresponding model output \( y \). This can be expressed as:
   
   \[
   y_i = f(x_i), \quad i = 1, 2, \ldots, n
   \]

- Estimated model outputs \( \hat{y}_1, \hat{y}_2, \ldots, \hat{y}_n \) obtained by applying the model function to the random input samples:
   
   \[
   \hat{y}_i = f(x_i), \quad i = 1, 2, \ldots, n
   \]



# Monte Carlo simulation 

```{r mcsimulation}
# Source our model
source("CODAS_Garden_Model.R")

# Ensure consistent results each time we run the MC
set.seed(1234) 

garden_simulation_results <- mcSimulation(
  estimate = estimate_read_csv("inputs_school_garden.csv"),
  model_function = school_garden_function,
  numberOfModelRuns = 1000, #run 1000 times
  functionSyntax = "plainNames"
)
```

The way we present NPV values can influence decision makers. The same information presented in different ways can even lead to different decisions. Here we derive a plot that compares the decision options as pure NPV values. 

```{r}
source("functions/plot_distributions.R")
plot_distributions(mcSimulation_object = garden_simulation_results, 
                                    vars = c("NPV_garden", "NPV_no_garden"),
                                    method = 'hist_simple_overlay', 
                                    base_size = 7, 
                                    x_axis_name = "Comparative NPV outcomes")
```

## Framing the outcomes 

Under Prospect Theory the way we present NPV values can influence decision makers - the same information presented in different ways can lead to different decisions. For example, framing a projected NPV gain as a "reduction in potential loss" might make it more attractive to decision makers due to loss aversion. 

Here we plot the distribution for the decision and frame the projected NPV gain for the 'decision' (distributions for the two options with the NPV values of the `no garden` option subtracted from those for the `garden`). If we display this as a "Reduction in potential loss" it might be more attractive to decision makers due to loss aversion, i.e. school boards might put more emphasis on avoiding potential losses than on seeking gains. We can frame our results as a strategy that minimizes losses rather than one that maximizes gains.

```{r framing_NPV_results}
plot_distributions(mcSimulation_object = garden_simulation_results, 
                                    vars = "decision",
                                    method = 'hist_simple_overlay', 
                                    base_size = 7,  
                                    x_axis_name = "Reduction in potential loss")

```


## Summary of results for the decision

Summary of the savings 

```{r summary_decision}
summary(garden_simulation_results$y$decision)
```

Summary of costs 

```{r summary_costs}
summary(garden_simulation_results$y$total_costs)
```

# Cashflow of the garden option
```{r}
source("functions/plot_cashflow.R")
plot_cashflow(mcSimulation_object = garden_simulation_results, 
              cashflow_var_name = "Cashflow_garden")
```
# EVPI 


```{r}
# Subset the outputs from the mcSimulation function (y) by selecting the correct variables be sure to run the multi_EVPI only on the variables that the we want.
mcSimulation_table <- data.frame(garden_simulation_results$x, 
                                 garden_simulation_results$y[1:3])
source("functions/multi_EVPI.R")
evpi <- multi_EVPI(mc = mcSimulation_table, first_out_var = "NPV_garden")

source("functions/plot_evpi.R")
plot_evpi(evpi, decision_vars = "decision")
```

# PLS

Projection to Latent Structures model can give us some sense of the correlation strength and direction for model variable and our outcome variables.


```{r}
source("functions/pls_model.R")
pls_result <- pls_model(object = garden_simulation_results,
                                resultName = names(garden_simulation_results$y)[1], 
                                ncomp = 1)

input_table <- read.csv("inputs_school_garden.csv")
source("functions/plot_pls.R")
plot_pls(pls_result, input_table = input_table, threshold = 0)
```

# More on Prospect Theory

We should consider these for our presentations for decison makers. 

Impact of Reference Points: The choice of reference point against which the forecast NPV values are evaluated can significantly influence decisions. Prospect Theory suggests that if the reference point is set at a higher NPV (e.g., a best-case scenario), decision makers might take more risks to achieve gains above that reference point.

Nonlinear Evaluation of Outcomes: Prospect Theory's value function implies that the perceived value of NPV gains diminishes as they get larger, and losses are more severely felt than gains. This could lead decision makers to prioritize actions that protect against losses and ensure stability even if those actions don't maximize the overall NPV.






