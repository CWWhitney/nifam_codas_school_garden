---
title: "School gardens in urban Hanoi"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(gtExtras)
library(svglite)
```

Here we model an intervention to address malnutrition among school-aged children in urban Hanoi. The gardens will be existing areas on school grounds. The STEM option gardens will be designed to for teaching about nutrition and STEM (an approach to learning and development that integrates science, technology, engineering and maths) at primary and secondary schools. 

The model was developed across several iterative workshops in July 2023. These included decision definition, conceptual model development of the selected decision and an initial programming session with preliminary model results. The resulting model was further developed through August to November 2023. A test run of the intervention will be carried out by the Center for the Development of Organic Agriculture (CODAS) under the Association of Organic Agriculture of Vietnam. In the 2nd year the garden is expected to start running well. The 3rd year is when the STEM education plan will be fully running.

![](figures/outline.png)

# Should urban Hanoi school boards invest time and money in creating school gardens? Should they invest in formal STEM education as part of these gardens?

# Urban Hanoi school garden 

This is the link to our simulation of the school garden intervemntion options.

```{r mcsimulation}
# Source our model
source("CODAS_Garden_Model.R")

# Ensure consistent results with the random number generator
# not for each 'run' of the MC simulation but for 
# consistency each time we call on the simulation 
set.seed(1234) 

garden_simulation_results <- mcSimulation(
  estimate = estimate_read_csv("inputs_school_garden.csv"),
  model_function = school_garden_function,
  numberOfModelRuns = 1000, #run 1000 times
  functionSyntax = "plainNames"
)

```

Here is a plot of the Net Present Value (i.e. current value of the future benefits) of the three options. `"NPV_garden"` is the value of the 5 years of the garden intervention.`"NPV_garden_STEM"` is the same garden but with the additional costs and benefits of a full STEM education program, `"NPV_no_garden"` is the result of 5 years of using the land for something that is not related to the garden, i.e. as a playground or for parking: 

```{r}
source("functions/plot_distributions.R")
plot_distributions(mcSimulation_object = garden_simulation_results, 
                                    vars = c("NPV_garden","NPV_garden_STEM", "NPV_no_garden"),
                                    method = 'hist_simple_overlay', 
                                    base_size = 7, 
                                    x_axis_name = "Comparative NPV outcomes")
```

## Framing the outcomes

Under Prospect Theory the way we present NPV values can influence decision makers - the same information presented in different ways can lead to different decisions. For example, framing a projected NPV gain as a "reduction in potential loss" might make it more attractive to decision makers due to loss aversion.

Here we plot the distribution for the decision and frame the projected NPV gain for the 'decision'. These are distributions for the options, with the NPV values of the no garden option subtracted from those for the garden, the `decision` and garden with STEM, the `decision_STEM`. We display this as a "Reduction in potential loss" as it is expected to be more attractive to decision makers due to loss aversion, i.e. school boards might put more emphasis on avoiding potential losses than on seeking gains. We can frame our results as a strategy that minimizes losses rather than one that maximizes gains.

```{r framing_NPV_results}
plot_distributions(mcSimulation_object = garden_simulation_results, 
                                    vars = c("decision", "decision_STEM"),
                                    method = 'hist_simple_overlay', 
                                    base_size = 7,  
                                    x_axis_name = "Reduction in potential loss")

```

## Summary of results for the decision

## Summary

Here we provide a summary of the garden intervention options with `gt_plt_summary()` from {gtExtras} and with options from {svglite}. 

```{r gtExtras_summary}
# Subset the outputs from the mcSimulation function (y) to summarize only on the variables that we want.
# names(garden_simulation_results$x)
mcSimulation_summary <- data.frame(garden_simulation_results$x[2:61],
 # names(garden_simulation_results$x)
                                 garden_simulation_results$y[1:7])

gt_plt_summary(mcSimulation_summary) 
```

Summary of the savings for the passive education garden option

```{r summary_decision}
summary(garden_simulation_results$y$decision)
```

Summary of the savings for the formal STEM education garden option

```{r summary_decision_stem}
summary(garden_simulation_results$y$decision_STEM)
```


Summary of costs

```{r summary_costs}
summary(garden_simulation_results$y$total_costs)
```

```{r summary_costs_stem}
summary(garden_simulation_results$y$total_costs_STEM)
```

# First year

```{r summary_first_year_costs}
summary(garden_simulation_results$y$Cashflow_garden1)
```

```{r summary_first_year_costs_stem}
summary(garden_simulation_results$y$Cashflow_garden_STEM1)
```
# Cashflow of the garden option without formal STEM education

```{r}
source("functions/plot_cashflow.R")
plot_cashflow(mcSimulation_object = garden_simulation_results, 
              cashflow_var_name = "Cashflow_garden")

```

Cashflow of the garden option with formal STEM education

```{r}
source("functions/plot_cashflow.R")
plot_cashflow(mcSimulation_object = garden_simulation_results, 
              cashflow_var_name = "Cashflow_garden_STEM")
```

# Expected Value of Perfect Information (EVPI)

Here we assess value of information with the `multi_EVPI` function.

```{r}
# Subset the outputs from the mcSimulation function (y) by selecting the correct variables be sure to run the multi_EVPI only on the variables that we want. Find them with names(garden_simulation_results$y)
mcSimulation_table <- data.frame(garden_simulation_results$x, 
                                 garden_simulation_results$y[1:5])
```

Value of information for the garden option (no STEM).

```{r evpi-assess-garden}
source("functions/multi_EVPI.R")
# first_out_var is the first result variable in the table, "NPV_garden" in our case.
evpi <- multi_EVPI(mc = mcSimulation_table, first_out_var = "NPV_garden")

source("functions/plot_evpi.R")
plot_evpi(evpi, decision_vars = "decision")
```
Value of information for the garden option with formal STEM education.

```{r evpi-assess-garden-stem}
# using the results of the same multi_EVPI
plot_evpi(evpi, decision_vars = "decision_STEM")
```

# PLS

We use Projection to Latent Structures model to get some sense of the correlation strength and direction for model variables and our outcome variables.

For passive education garden option

```{r}
source("functions/pls_model.R")
pls_result <- pls_model(object = garden_simulation_results,
                                resultName = names(garden_simulation_results$y)[1], # the "NPV_garden" 
                                ncomp = 1)
# read in the common input table
input_table <- read.csv("inputs_school_garden.csv")
# source the plot function
source("functions/plot_pls.R")
plot_pls(pls_result, input_table = input_table, threshold = 0.9)
```

For school garden with formal STEM education

```{r}
pls_result_STEM <- pls_model(object = garden_simulation_results,
                                resultName = names(garden_simulation_results$y)[2], # the "NPV_garden_STEM" 
                                ncomp = 1)

plot_pls(pls_result_STEM, input_table = input_table, threshold = 0.9)
```


The full repository can be accessed at https://github.com/CWWhitney/nifam_codas_school_garden with the following QR code.

<!-- The git create a qr -->
<!-- library(qrcode) -->
<!-- qrcode_gen('https://github.com/CWWhitney/kon_tum_homegardens') -->

![](figures/CODAS_School_garden_git.png)